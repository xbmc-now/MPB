// TstOpn.cpp : コンソール アプリケーションのエントリ ポイントを定義します。
//

#include "stdafx.h"
#include "TstOpn.h"


#ifdef _DEBUG
#define new DEBUG_NEW
#endif


// 唯一のアプリケーション オブジェクトです。

CWinApp theApp;

using namespace std;


int _tmain(int argc, TCHAR* argv[], TCHAR* envp[])
{
	int nRetCode = 0;

	HMODULE hModule = ::GetModuleHandle(NULL);

	if (hModule != NULL)
	{
		// MFC を初期化して、エラーの場合は結果を印刷します。
		if (!AfxWinInit(hModule, NULL, ::GetCommandLine(), 0))
		{
			// TODO: 必要に応じてエラー コードを変更してください。
			_tprintf(_T("致命的なエラー: MFC の初期化ができませんでした。\n"));
			nRetCode = 1;
		}
		else
		{
			// TODO: アプリケーションの動作を記述するコードをここに挿入してください。

			_tsetlocale(LC_ALL, _T("Japanese_Japan.932"));

//------------------------------------------------------------------------------


			FILE *fp;
			wchar_t str[256];
			fpos_t NowFileSize = 0;
			fpos_t PreFileSize = 0;

			while(1){
				if((fp = fopen("test.txt", "r, ccs=UTF-8")) == NULL ) {
					_tprintf(_T("ファイルオープンエラー\n"));
					Sleep(1000);
				} else {


					fseek(fp,0,SEEK_END); 
					fgetpos(fp,&NowFileSize); // 現在ファイルサイズ取得

					if(PreFileSize == 0 ){ // 初期ファイルサイズ取得
						PreFileSize = NowFileSize;
					}




					if(PreFileSize > NowFileSize){ // 現在のファイルサイズが前回よりも小さい場合は前回をゼロにする。
						PreFileSize = 0;
					}
					if(PreFileSize < NowFileSize){
						fseek(fp, PreFileSize, SEEK_SET); // シーク
						while ( fgetws(str, 256, fp) != NULL ) { // 追加分を表示
							_tprintf(str);
						}
						PreFileSize = NowFileSize; // ファイルサイズを代入
					}
					fclose(fp);
					Sleep(100);
				}

			}






//------------------------------------------------------------------------------
			_tprintf(_T("Hello World!!\n"));
		}
	}
	else
	{
		// TODO: 必要に応じてエラー コードを変更してください。
		_tprintf(_T("致命的なエラー: GetModuleHandle が失敗しました\n"));
		nRetCode = 1;
	}
	getchar();
	return 0;
	//return nRetCode;
}
